<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Automated Time Metric</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {font-family: Arial, sans-serif; margin: 20px; background: #f4f6f9;}
  h1, h2 {text-align: center; color: #2c3e50;}
  .container {max-width: 1400px; margin: auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1);}
  .table-wrapper {overflow-x:auto; margin-top:20px;}
  table {width: 100%; border-collapse: collapse; min-width: 1200px;}
  th, td {border: 1px solid #ddd; padding: 10px; text-align: center; white-space: nowrap;}
  th {background: #3498db; color: white;}
  select, input, button, textarea {padding: 6px; margin: 4px 0; font-size: 14px;}
  textarea {width: 160px; height: 60px; resize: none;}
  .controls {text-align: center; margin: 20px 0; overflow-x:auto; white-space: nowrap;}
  .btn {padding: 8px 14px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; color: #fff; font-weight: 600;}
  .btn-add {background: #27ae60;}
  .btn-export {background: #2980b9;}
  .btn-preview {background: #16a085;}
  .btn-clear {background: #c0392b;}
  .btn-backup {background: #d35400;}
  .btn-restore {background: #2c3e50;}
  .btn-summary {background: #8e44ad;}
  .btn-toggle-summary {background: #9b59b6;}
  .row-action-btn {padding:6px 10px; margin-left:6px; border-radius:4px; cursor:pointer; border:none; color:#fff;}
  .row-add {background:#2ecc71;}
  .row-delete {background:#e74c3c;}
  .resolved {background: #d5efda !important; color: #155724;}
  .pending {background: #fff3cd !important; color: #856404;}
  .downtime {background: #f8d7da !important; color: #721c24;}
  .summary {margin-top: 30px; padding: 15px; background: #ecf0f1; border-radius: 8px;}
  .summary-section {margin-bottom: 25px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
  .summary-title {font-weight: bold; font-size: 1.3em; margin-bottom: 10px; color: #2c3e50;}
  .chart-container {position: relative; height: 300px; margin-top: 15px;}
  .staff-table {width: 100%; margin-top: 10px; border-collapse: collapse;}
  .staff-table th {background: #34495e; color: white;}
  .staff-table td {background: #f9f9f9;}
  .small {font-size: 12px;}
  input[type="date"], input[type="datetime-local"] {padding:6px;}
  select {min-width:130px;}
  .cell-duration {min-width:80px;}
  #monthSelectorContainer, #quarterSelectorContainer {display: none; margin-left: 15px;}
  .autosave-indicator {font-size: 12px; color: #27ae60; text-align: center; margin-top: 10px;}
  @media (max-width: 900px) {
    .staff-table, .staff-table thead, .staff-table tbody, .staff-table th, .staff-table td, .staff-table tr {display: block;}
    .staff-table th, .staff-table td {text-align: left;}
    .chart-container {height: 250px;}
  }
</style>
</head>
<body>
<div class="container">
  <h1>Automated Time Metric</h1>
  <h2>Customer Service Time Metrics Tracker</h2>
  <div class="controls period-controls">
    <label class="small">Select Year:</label>
    <select id="metricYear" onchange="updateYear()">
      <option value="2026">2026</option>
      <option value="2027">2027</option>
      <option value="2028">2028</option>
      <option value="2029">2029</option>
      <option value="2030">2030</option>
    </select>
    <label class="small" style="margin-left:10px">Date (Mondays only):</label>
    <input type="date" id="metricDate" onchange="onDateSelected()">
    <span id="monthSelectorContainer">
      <label class="small">Monthly:</label>
      <select id="monthSelector" onchange="updateMonthlySummary()"></select>
    </span>
    <span id="quarterSelectorContainer">
      <label class="small">Quarterly:</label>
      <select id="quarterSelector" onchange="updateQuarterlySummary()"></select>
    </span>
  </div>
  <div class="controls entry-controls">
    <label class="small" style="margin-left:10px">Shift:</label>
    <select id="shift">
      <option value="">--Select Shift--</option>
      <option value="Morning">Morning Shift</option>
      <option value="Night">Night Shift</option>
    </select>
    <label class="small" style="margin-left:10px">Staff:</label>
    <select id="staff">
      <option value="">-- Select Staff --</option>
      <option>Abdubakar Abdullahi</option>
      <option>Alade Adeola James</option>
      <option>Jolaiya Adejumoke</option>
      <option>Olabiyi Oluwafemisii</option>
    </select>
    <button class="btn btn-add" onclick="addRowFromTop()">Add Entry</button>
    <button class="btn btn-toggle-summary" id="toggleSummaryBtn" onclick="toggleSummary()">Show Summary</button>
  </div>
  <div class="table-wrapper">
    <table id="metricsTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Shift</th>
          <th>Staff</th>
          <th>Complaint</th>
          <th>Response Time</th>
          <th>Resolution Time</th>
          <th>Duration (min)</th>
          <th>Status</th>
          <th>Notes</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="autosave-indicator" id="autosaveStatus">Autosave: Enabled (every 10 seconds + on change)</div>

  <div class="summary" id="summarySection" style="display: none;">
    <!-- Summary sections remain unchanged -->
    <div class="summary-section">
      <div class="summary-title">Yearly Summary <span id="yearlyPeriod"></span></div>
      <p>Resolved: <span id="yearlyResolved">0</span> |
         Pending: <span id="yearlyPending">0</span> |
         Downtime: <span id="yearlyDowntime">0</span></p>
      <p>Average Handling Time per Chat: <span id="yearlyAvgHandling">0</span> minutes</p>
      <p>Resolution Rate: <span id="yearlyResolutionRate">0</span>%</p>
      <p><strong>Most Frequent Complaint:</strong> <span id="yearlyTopComplaint">-</span> (<span id="yearlyTopCount">0</span>)</p>
      <div class="chart-container">
        <canvas id="yearlyChart"></canvas>
      </div>
    </div>
    <div class="summary-section">
      <div class="summary-title">Weekly Summary <span id="weeklyPeriod"></span></div>
      <p>Resolved: <span id="weeklyResolved">0</span> |
         Pending: <span id="weeklyPending">0</span> |
         Downtime: <span id="weeklyDowntime">0</span></p>
      <p>Average Handling Time per Chat: <span id="weeklyAvgHandling">0</span> minutes</p>
      <p>Resolution Rate: <span id="weeklyResolutionRate">0</span>%</p>
      <p><strong>Most Frequent Complaint:</strong> <span id="weeklyTopComplaint">-</span> (<span id="weeklyTopCount">0</span>)</p>
      <div class="chart-container">
        <canvas id="weeklyChart"></canvas>
      </div>
    </div>
    <div class="summary-section">
      <div class="summary-title">Monthly Summary <span id="monthlyPeriod"></span></div>
      <p>Resolved: <span id="monthlyResolved">0</span> |
         Pending: <span id="monthlyPending">0</span> |
         Downtime: <span id="monthlyDowntime">0</span></p>
      <p>Average Handling Time per Chat: <span id="monthlyAvgHandling">0</span> minutes</p>
      <p>Resolution Rate: <span id="monthlyResolutionRate">0</span>%</p>
      <p><strong>Most Frequent Complaint:</strong> <span id="monthlyTopComplaint">-</span> (<span id="monthlyTopCount">0</span>)</p>
      <div class="chart-container">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>
    <div class="summary-section">
      <div class="summary-title">Quarterly Summary <span id="quarterlyPeriod"></span></div>
      <p>Resolved: <span id="quarterlyResolved">0</span> |
         Pending: <span id="quarterlyPending">0</span> |
         Downtime: <span id="quarterlyDowntime">0</span></p>
      <p>Average Handling Time per Chat: <span id="quarterlyAvgHandling">0</span> minutes</p>
      <p>Resolution Rate: <span id="quarterlyResolutionRate">0</span>%</p>
      <p><strong>Most Frequent Complaint:</strong> <span id="quarterlyTopComplaint">-</span> (<span id="quarterlyTopCount">0</span>)</p>
      <div class="chart-container">
        <canvas id="quarterlyChart"></canvas>
      </div>
    </div>
    <div class="summary-section">
      <div class="summary-title">Staff Performance Breakdown <span id="staffPeriod"></span></div>
      <div class="table-wrapper">
        <table class="staff-table" id="staffTable">
          <thead>
            <tr>
              <th>Staff</th>
              <th>Resolved</th>
              <th>Pending</th>
              <th>Downtime</th>
              <th>Avg Handling Time (min)</th>
              <th>Resolution Rate (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="chart-container">
        <canvas id="staffChart"></canvas>
      </div>
    </div>
  </div>
  <div class="controls">
    <button class="btn btn-export" onclick="exportToExcel()">Export to Excel</button>
    <button class="btn btn-preview" onclick="previewData()">Preview</button>
    <button class="btn btn-backup" onclick="backupData()">Backup Data</button>
    <button class="btn btn-restore" onclick="document.getElementById('restoreFile').click()">Restore Backup</button>
    <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreBackup(event)">
    <button class="btn btn-clear" onclick="clearAllData()">Clear All Data</button>
  </div>
</div>
<script>
// Global variables
const complaints = [
  "--Select complaint--",
  "General inquiries/complaints",
  "Auto agent",
  "Xendify",
  "Safe Heaven MFB",
  "Monnify",
  "Refund",
  "Account restoration",
  "Electricity",
  "Cable Subscription",
  "Data"
];
const staffList = [
  "Abdubakar Abdullahi",
  "Alade Adeola James",
  "Jolaiya Adejumoke",
  "Olabiyi Oluwafemisii"
];
let selectedYear = 2026;
let currentSelectedDate = null;
let currentMonth = null;
let currentQuarter = null;
let autosaveIntervalHandle = null;
const AUTOSAVE_INTERVAL_MS = 10000; // Every 10 seconds
let yearlyChart = null, weeklyChart = null, monthlyChart = null, quarterlyChart = null, staffChart = null;

// Rest of your functions remain exactly the same until save/load section
// ... (all functions: updateYear, generateMondays, onDateSelected, etc.)

function storageKeyForYear(year) { return "automatedMetrics" + year; }

function saveData() {
  const data = [];
  document.querySelectorAll("#tableBody tr").forEach(row => {
    data.push({
      date: row.querySelector(".row-date")?.value || "",
      shift: row.querySelector(".row-shift")?.value || "",
      staff: row.querySelector(".row-staff")?.value || "",
      complaint: row.querySelector(".complaint-select")?.value || "",
      response: row.querySelector(".response-input")?.value || "",
      resolution: row.querySelector(".resolution-input")?.value || "",
      duration: row.querySelector(".cell-duration")?.textContent || "0",
      status: row.querySelector(".status-select")?.value || "",
      notes: row.querySelector(".notes-textarea")?.value || ""
    });
  });
  localStorage.setItem(storageKeyForYear(selectedYear), JSON.stringify(data));
  
  // Optional: subtle feedback
  const statusEl = document.getElementById("autosaveStatus");
  if (statusEl) {
    statusEl.textContent = "Autosaved just now";
    setTimeout(() => {
      statusEl.textContent = "Autosave: Enabled (every 10 seconds + on change)";
    }, 2000);
  }
}

function loadData() {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  const saved = localStorage.getItem(storageKeyForYear(selectedYear));
  if (saved) {
    try {
      const data = JSON.parse(saved);
      data.forEach(item => tbody.appendChild(createRowElement(item)));
    } catch (e) { console.error("Failed to load data:", e); }
  }
  updateSummary();
}

// Enhanced autosave system
function startAutosave() {
  // Clear any existing interval
  if (autosaveIntervalHandle) clearInterval(autosaveIntervalHandle);

  // Periodic autosave every 10 seconds
  autosaveIntervalHandle = setInterval(() => {
    saveData();
  }, AUTOSAVE_INTERVAL_MS);

  // Save on page unload (tab close, refresh, etc.)
  window.addEventListener("beforeunload", () => {
    saveData();
  });
}

// Keep all your existing functions: backupData, restoreBackup, clearAllData, etc.
// ... (unchanged)

// Init
document.getElementById("metricYear").value = String(selectedYear);
generateMondays(selectedYear);
loadData();
startAutosave(); // This starts both periodic and on-unload saves

// Critical: This listener already handles autosave on EVERY field change including complaint!
document.addEventListener("focusout", (e) => {
  if (e.target?.matches(".row-date,.row-shift,.row-staff,.complaint-select,.response-input,.resolution-input,.status-select,.notes-textarea")) {
    const row = e.target.closest("tr");
    if (row) {
      calculateDurationForRow(row); // Update duration if needed
      saveData();                  // Immediate save
      updateSummary();             // Refresh stats
    }
  }
});
</script>
</body>
</html>
